$(".next_button").off().on('click', function () {
  if(trackNo == album_data["no_of_tracks"]) {
    end();
  }
  else {
    skipForwards();
  }
});

$(".previous_button").off().on('click', function () {
  skipBackwards();
});

var end = function() {
  $("#jplayer2, #jplayer1").jPlayer("clearMedia");
  $('#player').removeClass('open-slider');
  $('#menu-button').removeClass('rotate');
};

var updatePlayer = function() {
  $('#player_song').text(album_data["tracks"]["track_names"][trackNo]);
  $('#player_artist').text(album_data["tracks"]["track_artists"][trackNo]);
  $('#player_album').text(album_data["album_name"]);
  $('#player_cover').css("background-image", "url(" + album_data["album_art"] + ")");
};

var skipForwards = function() {
  if (trackNo % 2 === 0) {
    $("#jplayer2").jPlayer("setMedia", {
      m4a: album_data["tracks"]["preview_urls"][trackNo]
    });
  }
  else {
    $("#jplayer1").jPlayer("setMedia", {
      m4a: album_data["tracks"]["preview_urls"][trackNo]
    });
  }
  play();
};

var skipBackwards = function() {
    if (trackNo == 1) {
      trackNo = trackNo - 1;
    }
    else {
      trackNo = trackNo - 2; // because play function accelerates straight through to nextTrack which puts the track no up one, we have to go back two spaces, similarly, we don't have to put next track forward at all
    }
    if (trackNo % 2 === 0) {
      $("#jplayer2").jPlayer("setMedia", {
        m4a: album_data["tracks"]["preview_urls"][trackNo]
      });
    }
    else {
      $("#jplayer1").jPlayer("setMedia", {
        m4a: album_data["tracks"]["preview_urls"][trackNo]
      });
    }
    play();
};

var nextTrack = function() {
  if (trackNo >= album_data["tracks"]["preview_urls"].length) {
    end();
  }
  else {
    updatePlayer();
    trackNo = trackNo + 1;
    if (trackNo % 2 === 0) {
      $("#jplayer2").jPlayer("setMedia", {
        m4a: album_data["tracks"]["preview_urls"][trackNo]
      });
    }
    else {
      $("#jplayer1").jPlayer("setMedia", {
        m4a: album_data["tracks"]["preview_urls"][trackNo]
      });
    }
  }
};

var play = function() {
  if (trackNo % 2 === 0) {
    $("#jplayer2").jPlayer("play");
  }
  else {
    $("#jplayer1").jPlayer("play");
  }
  nextTrack();
  $('#player').addClass('open-slider');
  $('#menu-button').addClass('rotate');
};


//START HERE

var album_data = <%= raw json_escape(@album_data) %>;

var trackNo = 0;

$("#jplayer1, #jplayer2").jPlayer({
  timeupdate: function(event) {
    if (event.jPlayer.status.currentTime >= (album_data["duration"]/1000)) {
      play();
    }
  },
  swfPath: "/js",
  supplied: "m4a"
});

$("#jplayer2").jPlayer("setMedia", {
  m4a: album_data["tracks"]["preview_urls"][trackNo]
});

play();

$(".stop_button").off().on('click', function () {
  end();
});